name: Formatter

on:
  workflow_call:

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: julia-actions/setup-julia@latest

      # ðŸ§° Cache des artefacts Julia
      - name: Cache Julia artifacts
        uses: actions/cache@v4
        with:
          path: ~/.julia/artifacts
          key: ${{ runner.os }}-julia-artifacts-${{ hashFiles('Project.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-artifacts-

      # âš¡ Cache du code prÃ©compilÃ©
      - name: Cache Julia compiled code
        uses: actions/cache@v4
        with:
          path: ~/.julia/compiled
          key: ${{ runner.os }}-julia-compiled-${{ hashFiles('Project.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-compiled-

      # ðŸ§± (optionnel) Construire le package local s'il existe
      - uses: julia-actions/julia-buildpkg@latest

      # ðŸŽ¨ Installer JuliaFormatter et formater le code
      - name: Install JuliaFormatter and format
        run: |
          julia -e 'using Pkg; Pkg.add("JuliaFormatter")'
          julia -e 'using JuliaFormatter; format(".", BlueStyle())'

      # ðŸ¤– CrÃ©er une Pull Request avec le code formatÃ©
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ":robot: Format .jl files"
          title: '[AUTO] JuliaFormatter.jl run'
          branch: auto-juliaformatter-pr
          delete-branch: true
          labels: formatting, automated pr, no changelog

      # ðŸ§¾ Logs utiles
      - name: Check outputs
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"

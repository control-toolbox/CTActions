name: Formatter

on:
  workflow_call:

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@latest

      # ðŸ§° Cache Julia artifacts (binaries de JuliaFormatter et dÃ©pendances)
      - name: Cache Julia artifacts
        uses: actions/cache@v4
        with:
          path: ~/.julia/artifacts
          key: ${{ runner.os }}-formatter-artifacts-${{ hashFiles('**/formatter.lock') }}
          restore-keys: |
            ${{ runner.os }}-formatter-artifacts-

      # âš¡ Cache du code prÃ©compilÃ© (.ji)
      - name: Cache Julia compiled code
        uses: actions/cache@v4
        with:
          path: ~/.julia/compiled
          key: ${{ runner.os }}-formatter-compiled-${{ hashFiles('**/formatter.lock') }}
          restore-keys: |
            ${{ runner.os }}-formatter-compiled-

      # ðŸŽ¨ Installer JuliaFormatter dans un environnement vide et formater
      - name: Install JuliaFormatter and format
        run: |
          # crÃ©er un petit fichier de lock pour que le hash soit stable (clÃ© du cache)
          echo "JuliaFormatter-1" > formatter.lock
          julia --project=@empty -e '
            using Pkg
            Pkg.add("JuliaFormatter")
            using JuliaFormatter
            format(".", BlueStyle())
          '

      # ðŸ¤– CrÃ©er la Pull Request avec le code formatÃ©
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ":robot: Format .jl files"
          title: '[AUTO] JuliaFormatter.jl run'
          branch: auto-juliaformatter-pr
          delete-branch: true
          labels: formatting, automated pr, no changelog

      # ðŸ§¾ Logs utiles
      - name: Check outputs
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
